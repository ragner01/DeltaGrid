name: Promote to Staging

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to promote'
        required: true
        type: string
      skip_approval:
        description: 'Skip manual approval'
        required: false
        default: false
        type: boolean

env:
  AZURE_RESOURCE_GROUP: rg-deltagrid-staging
  AZURE_LOCATION: westeurope
  VERSION: ${{ github.event.inputs.version }}

jobs:
  approval:
    name: Manual Approval
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.skip_approval }}
    environment:
      name: staging
    steps:
      - name: Wait for approval
        run: echo "Waiting for manual approval to promote ${{ env.VERSION }} to staging"

  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    needs: approval
    if: always() && (needs.approval.result == 'success' || github.event.inputs.skip_approval)
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Verify infrastructure exists
        run: |
          az group exists --name ${{ env.AZURE_RESOURCE_GROUP }} || exit 1
      
      - name: Check for breaking changes
        run: |
          echo "Checking for breaking changes..."
          # Add breaking change detection logic

  deploy-to-staging:
    name: Deploy to Staging (Blue-Green)
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment:
      name: staging
    
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Deploy to staging slot (blue)
        uses: azure/webapps-deploy@v3
        with:
          app-name: app-deltagrid-api-staging
          images: ${{ secrets.ACR_LOGIN_SERVER }}/deltagrid-api:staging-${{ env.VERSION }}
          slot-name: staging
      
      - name: Run integration tests
        run: |
          # Run integration tests against staging slot
          dotnet test tests/IntegrationTests -c Release \
            --filter "Category=Integration" \
            --logger "trx;LogFileName=integration-results.trx"
      
      - name: Swap slots (staging â†’ production)
        if: success()
        run: |
          az webapp deployment slot swap \
            --name app-deltagrid-api-staging \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --slot staging \
            --target-slot production
      
      - name: Rollback on failure
        if: failure()
        run: |
          az webapp deployment slot swap \
            --name app-deltagrid-api-staging \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --slot production \
            --target-slot staging

